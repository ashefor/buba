<div class="dashboard">
  <div class="dashboard__container">
    <div class="pageheader">
      <ng-container *ngIf="(storedUserDetails$ | async) as storedUserDetails">
        <h1 class="pageheader__title text--capital">
          welcome<span>, {{storedUserDetails.firstname}}&nbsp;{{storedUserDetails.lastname}}</span>
        </h1>
        <span class="pageheader__subtitle text--capital">
          account summary
        </span>
      </ng-container>
    </div>
    <div class="pagebody dashboard__body">
      <div class="p-grid">
        <div class="p-col-12 p-md-12 p-lg-5 p-mr-auto dashboard__body__left">
          <div class="p-grid p-p-2">
            <div class="p-col-12 p-md-4 p-lg-12 balance p-mr-md-2 p-mr-lg-0">
              <span class="balance__header text--upper">
                balance
              </span>
              <ng-container *ngIf="loadingDetails; else loadedBalance">
                <div class="text--center py-2 loading">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
              </ng-container>
              <ng-template #loadedBalance>
                <span class="balance__amount text--700">
                  {{userdetails?.balance | currency: '₦ '}}
                </span>
              </ng-template>
            </div>
            <div class="p-col-12 p-md-4 p-lg-12 payment p-ml-md-2 p-ml-lg-0">
              <span class="payment__header text--upper">
                payment account details
              </span>
              <ng-container *ngIf="loadingDetails; else loadedAccountDetails">
                <div class="text--center loading">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
              </ng-container>
              <ng-template #loadedAccountDetails>
                <div *ngIf="userdetails && userdetails.payment_bank_name; else noAccountDetails">
                  <div class="p-grid payment__container py-3">
                    <div class="p-col-12 payment__details">
                      <div>
                        <span class="payment__bank payment__details__item text--capital">bank name: </span>
                      <strong class="p-ml-1 payment__bank payment__details__item text--capital">
                        {{userdetails.payment_bank_name? userdetails.payment_bank_name : 'Providus Bank'}}
                      </strong>
                      </div>
                     <div>
                       <span class="payment__name payment__details__item text--capital">
                        account name:
                       </span>
                      <strong class="p-ml-1 payment__name payment__details__item text--capital">
                        {{userdetails.payment_account_name ? userdetails.payment_account_name : 'N/A'}}
                      </strong>
                     </div>
                     <div>
                       <span class="payment__name payment__details__item text--capital">account number:</span>
                       <strong class="p-ml-1 payment__account payment__details__item text--700 text--capital">
                        {{userdetails.payment_account_number ? userdetails?.payment_account_number : 'N/A'}}
                      </strong>
                     </div>
                    </div>
                    <div class="p-col-12 payment__details__item p-as-center">
                      <button class="button button--secondary text--capital payment__addbutton payment__details__button"
                        (click)="refreshAccountDetails()">
                        refresh
                      </button>
                    </div>
                  </div>
                </div>
                <ng-template #noAccountDetails>
                  <div class="text--center loading">
                    <p *ngIf="badRequestError" class="text--regular text--danger p-mb-2">{{badRequestError}}</p>
                    <p class="text--regular">No Payment Account Found</p>
                    <button [disabled]="isCreating"
                      class="button button--sm button--secondary text--capital payment__addbutton payment__details__button"
                      (click)="createPaymentAccount()">
                      {{isCreating ? 'Creating..' : 'Create One'}}
                    </button>
                  </div>
                </ng-template>
              </ng-template>
            </div>
            <div class="p-col-12 p-md-4 p-lg-12 balance p-ml-md-2 p-ml-lg-0">
              <span class="balance__header text--upper">
                winning balance
              </span>
              <ng-container *ngIf="loadingDetails; else loadedWiningBalance">
                <div class="text--center py-2 loading">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
              </ng-container>
              <ng-template #loadedWiningBalance>
                <span class="balance__amount text--700">
                  {{userdetails?.winnings_balance | currency: '₦ '}}
                </span>
                <div class="p-mt-2">
                  <a [routerLink]="['/withdrawals/new']" class="button button--secondary text--capital payment__addbutton">
                    withdraw
                  </a>
                  <button (click)="openTransferModal()" class="p-ml-2 button button--secondary text--capital payment__addbutton">
                  transfer to wallet
                  </button>
                </div>
              </ng-template>
            </div>
          </div>
        </div>

        <div class="p-col-12  p-md-12 p-lg-6 p-mx-auto dashboard__body__right">
          <div class="referral">
            <span class="referral__header text--upper">
              referral details
            </span>
            <ng-container *ngIf="loadingDetails; else showReferral">
              <div class="text--center loading">
                <i class="pi pi-spin pi-spinner"></i>
              </div>
            </ng-container>
            <ng-template #showReferral>
              <div class="p-grid referral__container py-3">
                <div class="p-col-12 referral__details">
                  <span class="referral__bank referral__details__item text--capital">
                    Code: <strong>{{userdetails.referral_code? userdetails.referral_code : 'N/A'}}</strong>
                  </span>
                  <div class="p-grid p-ai-center p-mt-5">
                    <div class="p-col-10">
                      <textarea rows="2" #inputElement readonly class="form__input form__textarea" [value]="'https://account.buba.ng/register?referred_by=' + userdetails.referral_code">
                        </textarea>
                     </div>
                      <div class="p-col-2">
                        <button class="button button p-mx-2" (click)="copyTextToClipBoard(inputElement)">
                          <i class="pi pi-copy" style="font-size: 1.5rem"></i>
                        </button>
                      </div>
                   </div>
                </div>
              </div>
            </ng-template>
          </div>
          <div class="bids">
            <span class="bids__header text--upper">
              open bid(s)
            </span>
            <div class="bids__details">
              <ng-container *ngIf="isFetchingBids; else doneFetchingBids">
                <div class="text--center py-2 loading">
                  <i class="pi pi-spin pi-spinner"></i>
                </div>
              </ng-container>
              <ng-template #doneFetchingBids>
                <ng-container *ngIf="bidHistory">
                  <ng-container *ngIf="bidHistory.length; else noHistory">
                    <div>
                      <div *ngFor="let bid of bidHistory.slice(0, 5)" class="bids__open__container">
                        <div class="bids__open__body">
                          <div class="p-grid p-nogutter">
                            <div class="p-col-3">
                              <div class="bids__open__item">
                                <img class="bids__open__image" [src]="bid.product_image" alt="product">
                              </div>
                            </div>
                            <div class="p-col-9">
                              <div class="p-grid">
                                <div class="p-col-12">
                                  <div class="bids__open__item p-col text--left">
                                    <span class="bids__open__text text--medium text--bold">
                                      {{bid.product_name}}
                                    </span>
                                  </div>
                                </div>
                                <div class="p-col-12">
                                  <div class="bids__open__item p-col text--left">
                                    <span class="bids__open__text">
                                      {{bid.number_of_slot}} slot{{bid.number_of_slot > 1 ? 's' : ''}}
                                    </span>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <!-- <div class="bids__open__item p-col-2 text--right">
                            <a class="bids__open__footer__text bids__open__footer__text--link button">View</a>
                          </div> -->
                          </div>
                        </div>
                        <!-- <div class="bids__open__footer">
                        <span class="bids__open__footer__text bids__open__footer__text--left">Ends on: Oct 30th</span>
                        <a class="bids__open__footer__text bids__open__footer__text--link button button--secondary">View</a>
                      </div> -->
                      </div>
                    </div>
                    <div class="bids__open__item p-pt-5">
                      <a [routerLink]="['/bids']" class="bids__open__text bids__open__link">See all transactions</a>
                    </div>
                  </ng-container>
                  <ng-template #noHistory>
                    <div class="text--center bids__open__none">
                      <p class="bids__open__none__text">No open bids</p>
                    </div>
                  </ng-template>
                </ng-container>
              </ng-template>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>



<p-dialog [(visible)]="displayPosition" styleClass="transfer-modal" [modal]="true" [style]="{width: '35rem'}"
  [baseZIndex]="10000" [draggable]="false" [resizable]="false" (onHide)="resetModal()">
  <div class="modal-content p-px-1 p-mt-2">
    <h4 class="text--regular text--center p-mb-5">Enter how amount to transfer to wallet</h4>
    <form [formGroup]="transferFundsForm" (ngSubmit)="transferFunds(transferFundsForm.value)">
      <div class="p-fluid">
        <div class="p-field form__item">
          <label for="amount" class="form__label text--capital">amount</label>
          <input type="text" class="form__input form__input--lg" formControlName='amount' pKeyFilter="num">
          <ng-container
          *ngIf="(formControls.amount.dirty || formControls.amount.touched) && formControls.amount.errors">
          <span *ngIf="formControls.amount.errors.required"
            class="p-invalid p-mb-2 p-d-block p-px-2">Enter amount</span>
        </ng-container>
        </div>
          <ng-container *ngIf="transferFundsForm.errors && transferFundsForm.errors.badRequest">
            <div class="p-field form__item">
            <span class="p-invalid p-my-2 p-d-block">
              {{transferFundsForm.errors.badRequest}}
            </span>
          </div>
          </ng-container>
        <div class="p-field form__item">
          <button [disabled]="isTransferring" type="submit"
            class="button button--secondary button--raised text--capital button--wide">
            <i *ngIf="isTransferring" class="pi pi-spin pi-spinner p-mr-2"></i>
            {{isTransferring ? 'please wait' : 'transfer'}}
          </button>
        </div>
      </div>
    </form>
  </div>
</p-dialog>